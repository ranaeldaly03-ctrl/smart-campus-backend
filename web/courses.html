<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="courses.css">
  <title>Courses</title>
</head>
<body>


    <div class="menu">
        <ul>
            <li class="profile">
                <div class="img-box">
                    <img id="profilePic" src="" alt="profile">
                </div>

                <h2 id="adminName"></h2>
            </li>
            <li>
                <a href="admin.html">
                    <i class="fas fa-home"></i>
                    <p>dashboard</p>
                </a>
            </li>
            <li>
                <a href="users.html">
                    <i class="fas fa-user-group"></i>
                    <p>Users</p>
                </a>
            </li>
            <li>
                <a class="active" href="courses.html">
                    <i class="fa fa-list-alt"></i>
                    <p>Courses</p>
                </a>
            </li>
            <li>
                <a href="admin_schedule.html">
                    <i class="fas fa-table"></i>
                    <p>Tables</p>
                </a>
            </li>
            
            <li class="log-out">
                <a href="#">
                    <i class="fas fa-sign-out"></i>
                    <p>log Out</p>
                </a>
            </li>
        </ul>
    </div>

  <div class="courses">            
    <div class="title_info">
      <i class="fas fa-list-alt"></i>
      <h1 class="courses">View Course Details</h1>
    </div>

    <div class="filter">
      <label for="course">Course List</label>
      <table id="courses">
        <thead>
          <tr>
            <th>Course Name</th>
            <th>Department</th>
            <th>Professor</th>
            <th>Students Count</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="Students">
      <h2 id="studentsTitle">Select a Course to view Students</h2>
      <table id="studentsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Level</th>
            <th>Attendance</th>
            <th>Absences</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="msg"></p>
    <a href="student_course.html" class="add"><i class="fab fa-add"></i>Add student to a course</a>
    
  </div>

  <script>
    const api = "http://127.0.0.1:5000";

    document.addEventListener("DOMContentLoaded", () => {
            const name = localStorage.getItem("user_name");
            const role = localStorage.getItem("user_role");
            const image = localStorage.getItem("user_image");


            if (!name || role !== "Admin") {
                window.location.href = "login.html";
                return;
            }
               
            document.getElementById("adminName").textContent = name;
                
            const profilePic = document.getElementById("profilePic");
            
             if (image && image !== "null" && image !== ""){
                    document.getElementById("profilePic").src = `${api}/${image}`;
                } else {
                    document.getElementById("profilePic").src = `${api}/uploads/admin.png`;
                }

            
        });

    async function loadCourses() {
      const res = await fetch(`${api}/courses`);
      const data = await res.json();

      const tbody = document.querySelector("#courses tbody");
      tbody.innerHTML = "";

      data.courses.forEach(course => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${course.course_name}</td>    
          <td>${course.department}</td>    
          <td>${course.instructor_name || "-"}</td>    
          <td>${course.student_count}</td>    
        `;
        row.addEventListener("click", () => loadStudents(course.id, course.course_name));
        tbody.appendChild(row);
      });
    }

    async function loadStudents(courseId, courseName) {
      const res = await fetch(`${api}/courses/${courseId}/students`);
      const data = await res.json();

      const title = document.getElementById("studentsTitle");
      title.textContent = `ğŸ‘¨â€ğŸ“ Students in: ${courseName}`;

      const tbody = document.querySelector("#studentsTable tbody");
      tbody.innerHTML = "";

      if (!data.students || data.students.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>No students enrolled.</td></tr>";
        return;
      }

      data.students.forEach(st => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${st.id}</td>
          <td>${st.name}</td>
          <td>${st.email}</td>
          <td>${st.level}</td>
          <td>${st.attendance_count}</td>
          <td>${st.absence_count}</td>
        `;

        if (st.absence_count >= 3) {
          row.style.backgroundColor = "#ffb3b3"; // ğŸ”´ Ø£Ø­Ù…Ø± ÙØ§ØªØ­ Ù„Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ±
        }

        tbody.appendChild(row);
      });
    }

    function logout() 
            {
                localStorage.clear();
                window.location.href = "login.html";
            }

    window.onload = loadCourses;
  </script>
</body>
</html>
